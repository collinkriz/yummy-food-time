<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yummy Food Time</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons ---
        const Camera = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>;
        const Plus = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const MessageCircle = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>;
        const Search = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>;
        const Star = ({ className, onClick }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>;
        const MapPin = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>;
        const ExternalLink = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>;
        const UserIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const UploadIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const XIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const Utensils = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path><path d="M7 2v20"></path><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path></svg>;

        const YummyFoodTime = () => {
          const [currentUser, setCurrentUser] = useState('Collin');
          const [orders, setOrders] = useState([]);
          const [view, setView] = useState('home');
          const [selectedOrder, setSelectedOrder] = useState(null);
          const [uploadedImage, setUploadedImage] = useState(null);
          const [extracting, setExtracting] = useState(false);
          const [chatMessages, setChatMessages] = useState([]);
          const [chatInput, setChatInput] = useState('');
          const [chatLoading, setChatLoading] = useState(false);
          const [searchTerm, setSearchTerm] = useState('');
          const [newOrder, setNewOrder] = useState(null);
          const [apiKey, setApiKey] = useState('');
          const [showApiKeyModal, setShowApiKeyModal] = useState(false);

          useEffect(() => {
            const savedOrders = localStorage.getItem('yummy-orders');
            if (savedOrders) setOrders(JSON.parse(savedOrders));
            
            const savedApiKey = localStorage.getItem('anthropic-api-key');
            if (savedApiKey) setApiKey(savedApiKey);
          }, []);

          // Recalculate total for new orders automatically
          useEffect(() => {
            if (newOrder) {
                const calculatedTotal = (newOrder.subtotal || 0) + (newOrder.tax || 0) + (newOrder.deliveryFee || 0) + (newOrder.tip || 0);
                if (calculatedTotal !== newOrder.total) {
                    setNewOrder({ ...newOrder, total: calculatedTotal });
                }
            }
          }, [newOrder?.subtotal, newOrder?.tax, newOrder?.deliveryFee, newOrder?.tip]);

          const saveOrders = (updatedOrders) => {
            localStorage.setItem('yummy-orders', JSON.stringify(updatedOrders));
            setOrders(updatedOrders);
          };

          const handleImageUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (!apiKey) { setShowApiKeyModal(true); return; }

            setExtracting(true);
            setUploadedImage(URL.createObjectURL(file));

            try {
              const base64 = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
              });

              const response = await fetch('/api/anthropic', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  apiKey,
                  model: 'claude-3-7-sonnet-20250219',
                  max_tokens: 2000,
                  messages: [{
                    role: 'user',
                    content: [
                      { type: 'image', source: { type: 'base64', media_type: file.type, data: base64 } },
                      { type: 'text', text: `Extract food order details. Return ONLY JSON: {restaurant, platform, orderDate, location, items: [{name, price}], subtotal, tax, deliveryFee, tip, total}` }
                    ]
                  }]
                })
              });

              if (!response.ok) throw new Error('API request failed');
              const data = await response.json();
              const text = data.content.find(c => c.type === 'text')?.text || '';
              const cleaned = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
              const extracted = JSON.parse(cleaned);
              
              setNewOrder({
                ...extracted,
                id: Date.now().toString(),
                addedBy: currentUser,
                items: (extracted.items || []).map(i => ({ ...i, id: Math.random().toString(36).substr(2, 9), rating: 0, notes: '' }))
              });
              setView('review-order');
            } catch (error) {
              alert('Could not extract data. Please enter manually.');
              setNewOrder({
                  id: Date.now().toString(),
                  restaurant: '', platform: '', orderDate: new Date().toISOString().split('T')[0],
                  location: '', items: [{ id: '1', name: '', price: 0, rating: 0, notes: '' }],
                  subtotal: 0, tax: 0, deliveryFee: 0, tip: 0, total: 0, addedBy: currentUser
              });
              setView('review-order');
            } finally {
              setExtracting(false);
            }
          };

          const saveNewOrder = () => {
            saveOrders([...orders, newOrder]);
            setNewOrder(null);
            setView('history');
          };

          const updateItemRating = (orderId, itemId, rating) => {
            const updated = orders.map(o => o.id === orderId ? { ...o, items: o.items.map(i => i.id === itemId ? { ...i, rating } : i) } : o);
            saveOrders(updated);
            if (selectedOrder?.id === orderId) setSelectedOrder(updated.find(o => o.id === orderId));
          };

          const sendChatMessage = async () => {
            if (!chatInput.trim() || !apiKey) return;
            const userMsg = { role: 'user', content: chatInput };
            setChatMessages(prev => [...prev, userMsg]);
            setChatInput('');
            setChatLoading(true);

            try {
              const response = await fetch('/api/anthropic', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  apiKey,
                  model: 'claude-3-7-sonnet-20250219',
                  max_tokens: 1000,
                  messages: [{ role: 'user', content: `History: ${JSON.stringify(orders)}. User: ${chatInput}` }]
                })
              });
              const data = await response.json();
              setChatMessages(prev => [...prev, { role: 'assistant', content: data.content
