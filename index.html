<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yummy Food Time</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Icons
        const Camera = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>;
        const MessageCircle = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>;
        const Utensils = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path><path d="M7 2v20"></path><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path></svg>;
        const UserIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;

        const YummyFoodTime = () => {
          const [currentUser, setCurrentUser] = useState('Collin');
          const [orders, setOrders] = useState([]);
          const [view, setView] = useState('home');
          const [extracting, setExtracting] = useState(false);
          const [chatMessages, setChatMessages] = useState([]);
          const [chatInput, setChatInput] = useState('');
          const [chatLoading, setChatLoading] = useState(false);
          const [apiKey, setApiKey] = useState(localStorage.getItem('anthropic-api-key') || '');
          const [showApiKeyModal, setShowApiKeyModal] = useState(!localStorage.getItem('anthropic-api-key'));

          useEffect(() => {
            const savedOrders = localStorage.getItem('yummy-orders');
            if (savedOrders) setOrders(JSON.parse(savedOrders));
          }, []);

          const handleImageUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            setExtracting(true);
            try {
              const base64 = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
              });

              const response = await fetch('/api/anthropic', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  apiKey,
                  model: 'claude-3-7-sonnet-20250219',
                  max_tokens: 2000,
                  messages: [{ 
                    role: 'user', 
                    content: [
                        { type: 'image', source: { type: 'base64', media_type: file.type, data: base64 } },
                        { type: 'text', text: "Extract food order details. Return ONLY JSON: {restaurant, platform, orderDate, items: [{name, price}], total}" }
                    ] 
                  }]
                })
              });
              const data = await response.json();
              alert("Order Extracted!");
              setView('history');
            } catch (error) {
              alert('Error processing receipt.');
            } finally { setExtracting(false); }
          };

          const sendChatMessage = async () => {
            if (!chatInput.trim()) return;
            const userMsg = { role: 'user', content: chatInput };
            setChatMessages(prev => [...prev, userMsg]);
            setChatInput('');
            setChatLoading(true);
            try {
              const response = await fetch('/api/anthropic', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  apiKey,
                  model: 'claude-3-7-sonnet-20250219',
                  max_tokens: 1000,
                  messages: [{ role: 'user', content: chatInput }]
                })
              });
              const data = await response.json();
              const botText = data.content?.[0]?.text || "No response received.";
              setChatMessages(prev => [...prev, { role: 'assistant', content: botText }]);
            } catch (e) {
              setChatMessages(prev => [...prev, { role: 'assistant', content: 'Error connecting to AI.' }]);
            } finally { setChatLoading(false); }
          };

          return (
            <div className="min-h-screen p-4 max-w-5xl mx-auto">
              {showApiKeyModal && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white p-8 rounded-2xl max-w-sm w-full shadow-2xl">
                    <h3 className="text-xl font-bold mb-4">Enter API Key</h3>
                    <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="sk-ant-..." className="w-full p-3 border rounded-lg mb-4" />
                    <button onClick={() => { localStorage.setItem('anthropic-api-key', apiKey); setShowApiKeyModal(false); }} className="w-full py-3 bg-orange-500 text-white rounded-lg font-bold">Save Key</button>
                  </div>
                </div>
              )}

              <nav className="flex justify-between items-center mb-8">
                <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('home')}>
                  <Utensils className="text-orange-500 w-8 h-8" /><span className="text-xl font-black">YUMMY</span>
                </div>
                <div className="flex items-center gap-3 bg-white px-4 py-2 rounded-full shadow-sm border">
                  <UserIcon className="w-4 h-4 text-gray-400" />
                  <span className="font-bold">{currentUser}</span>
                </div>
              </nav>

              {view === 'home' && (
                <div className="space-y-6">
                  <div className="bg-gradient-to-r from-orange-500 to-pink-500 rounded-3xl p-10 text-white shadow-lg">
                    <h1 className="text-4xl font-bold mb-2">üçï Yummy Food Time</h1>
                    <p className="text-lg opacity-90">Manage your group orders and split bills instantly.</p>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <label className="bg-white rounded-2xl p-8 shadow-sm border hover:shadow-md transition-shadow flex flex-col items-center cursor-pointer">
                      <Camera className="w-12 h-12 text-orange-500 mb-4" />
                      <h3 className="text-xl font-bold">Upload Receipt</h3>
                      <input type="file" className="hidden" onChange={handleImageUpload} accept="image/*" />
                    </label>
                    <button onClick={() => setView('chat')} className="bg-white rounded-2xl p-8 shadow-sm border hover:shadow-md transition-shadow flex flex-col items-center">
                      <MessageCircle className="w-12 h-12 text-pink-500 mb-4" />
                      <h3 className="text-xl font-bold">Ask Assistant</h3>
                    </button>
                    <button onClick={() => setView('history')} className="bg-white rounded-2xl p-8 shadow-sm border hover:shadow-md transition-shadow flex flex-col items-center">
                      <Utensils className="w-12 h-12 text-purple-500 mb-4" />
                      <h3 className="text-xl font-bold">History</h3>
                    </button>
                  </div>
                </div>
              )}

              {view === 'chat' && (
                <div className="max-w-2xl mx-auto h-[600px] bg-white rounded-3xl shadow-xl flex flex-col border overflow-hidden">
                  <div className="p-4 border-b bg-orange-50 flex justify-between">
                    <span className="font-bold">AI Food Assistant</span>
                    <button onClick={() => setView('home')} className="text-sm text-orange-600 font-bold">Exit</button>
                  </div>
                  <div className="flex-1 overflow-y-auto p-6 space-y-4">
                    {chatMessages.map((m, i) => (
                      <div key={i} className={`p-4 rounded-2xl max-w-[80%] ${m.role === 'user' ? 'bg-orange-500 text-white ml-auto' : 'bg-gray-100'}`}>
                        {m.content}
                      </div>
                    ))}
                    {chatLoading && <div className="text-gray-400 animate-pulse italic">Thinking...</div>}
                  </div>
                  <div className="p-4 border-t flex gap-2">
                    <input className="flex-1 p-3 border rounded-xl outline-none focus:ring-2 focus:ring-orange-500" placeholder="Ask about your orders..." value={chatInput} onChange={e => setChatInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && sendChatMessage()} />
                    <button onClick={sendChatMessage} className="px-6 bg-orange-500 text-white rounded-xl font-bold">Send</button>
                  </div>
                </div>
              )}

              {view === 'history' && (
                <div className="space-y-4">
                  <button onClick={() => setView('home')} className="text-orange-500 font-bold">‚Üê Back</button>
                  <h2 className="text-2xl font-bold">Order History</h2>
                  {orders.length === 0 ? <p className="text-gray-400">No orders saved yet.</p> : orders.map(o => (
                    <div key={o.id} className="bg-white p-5 rounded-xl border flex justify-between items-center">
                      <div><h4 className="font-bold">{o.restaurant}</h4><p className="text-gray-400 text-sm">{o.orderDate}</p></div>
                      <div className="font-black">${o.total}</div>
                    </div>
                  ))}
                </div>
              )}

              {extracting && (
                <div className="fixed inset-0 bg-white/90 flex flex-col items-center justify-center z-50">
                  <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-orange-500 mb-4"></div>
                  <p className="text-xl font-black text-orange-500">Extracting Order Details...</p>
                </div>
              )}
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<YummyFoodTime />);
    </script>
</body>
</html>
